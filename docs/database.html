<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ER-диаграмма базы данных: Task Management System</title>
    <style>
        :root {
  /* Primitive Color Tokens */
  --color-white: rgba(255, 255, 255, 1);
  --color-black: rgba(0, 0, 0, 1);
  --color-cream-50: rgba(252, 252, 249, 1);
  --color-cream-100: rgba(255, 255, 253, 1);
  --color-gray-200: rgba(245, 245, 245, 1);
  --color-gray-300: rgba(167, 169, 169, 1);
  --color-gray-400: rgba(119, 124, 124, 1);
  --color-slate-500: rgba(98, 108, 113, 1);
  --color-brown-600: rgba(94, 82, 64, 1);
  --color-charcoal-700: rgba(31, 33, 33, 1);
  --color-charcoal-800: rgba(38, 40, 40, 1);
  --color-slate-900: rgba(19, 52, 59, 1);
  --color-teal-300: rgba(50, 184, 198, 1);
  --color-teal-400: rgba(45, 166, 178, 1);
  --color-teal-500: rgba(33, 128, 141, 1);
  --color-teal-600: rgba(29, 116, 128, 1);
  --color-teal-700: rgba(26, 104, 115, 1);
  --color-teal-800: rgba(41, 150, 161, 1);
  --color-red-400: rgba(255, 84, 89, 1);
  --color-red-500: rgba(192, 21, 47, 1);
  --color-orange-400: rgba(230, 129, 97, 1);
  --color-orange-500: rgba(168, 75, 47, 1);

  --color-brown-600-rgb: 94, 82, 64;
  --color-teal-500-rgb: 33, 128, 141;
  --color-slate-900-rgb: 19, 52, 59;
  --color-slate-500-rgb: 98, 108, 113;
  --color-red-500-rgb: 192, 21, 47;
  --color-red-400-rgb: 255, 84, 89;
  --color-orange-500-rgb: 168, 75, 47;
  --color-orange-400-rgb: 230, 129, 97;

  --color-bg-1: rgba(59, 130, 246, 0.08);
  --color-bg-2: rgba(245, 158, 11, 0.08);
  --color-bg-3: rgba(34, 197, 94, 0.08);
  --color-bg-4: rgba(239, 68, 68, 0.08);
  --color-bg-5: rgba(147, 51, 234, 0.08);
  --color-bg-6: rgba(249, 115, 22, 0.08);
  --color-bg-7: rgba(236, 72, 153, 0.08);
  --color-bg-8: rgba(6, 182, 212, 0.08);

  --color-background: var(--color-cream-50);
  --color-surface: var(--color-cream-100);
  --color-text: var(--color-slate-900);
  --color-text-secondary: var(--color-slate-500);
  --color-primary: var(--color-teal-500);
  --color-primary-hover: var(--color-teal-600);
  --color-primary-active: var(--color-teal-700);
  --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
  --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
  --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
  --color-border: rgba(var(--color-brown-600-rgb), 0.2);
  --color-btn-primary-text: var(--color-cream-50);
  --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
  --color-card-border-inner: rgba(var(--color-brown-600-rgb), 0.12);
  --color-error: var(--color-red-500);
  --color-success: var(--color-teal-500);
  --color-warning: var(--color-orange-500);
  --color-info: var(--color-slate-500);
  --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);
  --color-select-caret: rgba(var(--color-slate-900-rgb), 0.8);

  --focus-ring: 0 0 0 3px var(--color-focus-ring);
  --focus-outline: 2px solid var(--color-primary);

  --font-family-base: "FKGroteskNeue", "Geist", "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  --font-family-mono: "Berkeley Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
  --font-size-xs: 11px;
  --font-size-sm: 12px;
  --font-size-base: 14px;
  --font-size-md: 14px;
  --font-size-lg: 16px;
  --font-size-xl: 18px;
  --font-size-2xl: 20px;
  --font-size-3xl: 24px;
  --font-size-4xl: 30px;
  --font-weight-normal: 400;
  --font-weight-medium: 500;
  --font-weight-semibold: 550;
  --font-weight-bold: 600;
  --line-height-tight: 1.2;
  --line-height-normal: 1.5;
  --letter-spacing-tight: -0.01em;

  --space-0: 0;
  --space-1: 1px;
  --space-2: 2px;
  --space-4: 4px;
  --space-6: 6px;
  --space-8: 8px;
  --space-10: 10px;
  --space-12: 12px;
  --space-16: 16px;
  --space-20: 20px;
  --space-24: 24px;
  --space-32: 32px;

  --radius-sm: 6px;
  --radius-base: 8px;
  --radius-md: 10px;
  --radius-lg: 12px;
  --radius-full: 9999px;

  --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.02);
  --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.04), 0 4px 6px -2px rgba(0, 0, 0, 0.02);
  --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.15), inset 0 -1px 0 rgba(0, 0, 0, 0.03);

  --duration-fast: 150ms;
  --duration-normal: 250ms;
  --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);
}

@media (prefers-color-scheme: dark) {
  :root {
    --color-gray-400-rgb: 119, 124, 124;
    --color-teal-300-rgb: 50, 184, 198;
    --color-gray-300-rgb: 167, 169, 169;
    --color-gray-200-rgb: 245, 245, 245;

    --color-bg-1: rgba(29, 78, 216, 0.15);
    --color-bg-2: rgba(180, 83, 9, 0.15);
    --color-bg-3: rgba(21, 128, 61, 0.15);
    --color-bg-4: rgba(185, 28, 28, 0.15);
    --color-bg-5: rgba(107, 33, 168, 0.15);
    --color-bg-6: rgba(194, 65, 12, 0.15);
    --color-bg-7: rgba(190, 24, 93, 0.15);
    --color-bg-8: rgba(8, 145, 178, 0.15);

    --color-background: var(--color-charcoal-700);
    --color-surface: var(--color-charcoal-800);
    --color-text: var(--color-gray-200);
    --color-text-secondary: rgba(var(--color-gray-300-rgb), 0.7);
    --color-primary: var(--color-teal-300);
    --color-primary-hover: var(--color-teal-400);
    --color-primary-active: var(--color-teal-800);
    --color-secondary: rgba(var(--color-gray-400-rgb), 0.15);
    --color-secondary-hover: rgba(var(--color-gray-400-rgb), 0.25);
    --color-secondary-active: rgba(var(--color-gray-400-rgb), 0.3);
    --color-border: rgba(var(--color-gray-400-rgb), 0.3);
    --color-error: var(--color-red-400);
    --color-success: var(--color-teal-300);
    --color-warning: var(--color-orange-400);
    --color-info: var(--color-gray-300);
    --color-focus-ring: rgba(var(--color-teal-300-rgb), 0.4);
    --color-btn-primary-text: var(--color-slate-900);
    --color-card-border: rgba(var(--color-gray-400-rgb), 0.2);
    --color-card-border-inner: rgba(var(--color-gray-400-rgb), 0.15);
    --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.1), inset 0 -1px 0 rgba(0, 0, 0, 0.15);
  }
}

@font-face {
  font-family: 'FKGroteskNeue';
  src: url('https://r2cdn.perplexity.ai/fonts/FKGroteskNeue.woff2') format('woff2');
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: var(--font-family-base);
    background-color: var(--color-background);
    color: var(--color-text);
    overflow: hidden;
}

.header {
    background-color: var(--color-surface);
    border-bottom: 1px solid var(--color-border);
    padding: var(--space-16) var(--space-24);
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 100;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: var(--space-16);
}

.header h1 {
    font-size: var(--font-size-xl);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text);
}

.controls {
    display: flex;
    gap: var(--space-12);
    align-items: center;
}

.search-box {
    position: relative;
}

.search-box input {
    padding: var(--space-8) var(--space-12);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-base);
    background: var(--color-surface);
    color: var(--color-text);
    font-size: var(--font-size-sm);
    min-width: 200px;
}

.search-box input:focus {
    outline: var(--focus-outline);
    border-color: var(--color-primary);
}

.btn {
    padding: var(--space-8) var(--space-16);
    border-radius: var(--radius-base);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    cursor: pointer;
    transition: all var(--duration-fast) var(--ease-standard);
    border: none;
    background: var(--color-primary);
    color: var(--color-btn-primary-text);
}

.btn:hover {
    background: var(--color-primary-hover);
}

.btn-secondary {
    background: var(--color-secondary);
    color: var(--color-text);
}

.btn-secondary:hover {
    background: var(--color-secondary-hover);
}

.diagram-container {
    position: fixed;
    top: 70px;
    left: 0;
    right: 0;
    bottom: 0;
    overflow: auto;
    padding: var(--space-24);
}

.diagram {
    position: relative;
    min-width: 2400px;
    min-height: 1600px;
    transform-origin: top left;
    transition: transform var(--duration-normal) var(--ease-standard);
}

.table-box {
    position: absolute;
    min-width: 280px;
    background: var(--color-surface);
    border: 2px solid var(--color-card-border);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-md);
    cursor: pointer;
    transition: all var(--duration-fast) var(--ease-standard);
}

.table-box:hover {
    box-shadow: var(--shadow-lg);
    transform: translateY(-2px);
    border-color: var(--color-primary);
}

.table-header {
    padding: var(--space-12) var(--space-16);
    border-bottom: 2px solid currentColor;
    font-weight: var(--font-weight-bold);
    font-size: var(--font-size-base);
    border-top-left-radius: var(--radius-lg);
    border-top-right-radius: var(--radius-lg);
}

.table-body {
    padding: var(--space-12);
}

.field {
    padding: var(--space-4) var(--space-8);
    font-size: var(--font-size-xs);
    line-height: 1.6;
    font-family: var(--font-family-mono);
}

.field-name {
    font-weight: var(--font-weight-semibold);
    color: var(--color-text);
}

.field-type {
    color: var(--color-text-secondary);
    margin-left: var(--space-4);
}

.field-constraint {
    color: var(--color-primary);
    font-size: var(--font-size-xs);
    margin-left: var(--space-4);
}

svg.connections {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 0;
}

.table-box {
    z-index: 10;
}

.connection-line {
    stroke: var(--color-primary);
    stroke-width: 2;
    fill: none;
    opacity: 0.4;
}

.connection-line.optional {
    stroke-dasharray: 5,5;
}

.connection-arrow {
    fill: var(--color-primary);
    opacity: 0.6;
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: var(--space-24);
}

.modal.active {
    display: flex;
}

.modal-content {
    background: var(--color-surface);
    border-radius: var(--radius-lg);
    max-width: 800px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: var(--shadow-lg);
}

.modal-header {
    padding: var(--space-20) var(--space-24);
    border-bottom: 1px solid var(--color-border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    background: var(--color-surface);
    z-index: 10;
}

.modal-header h2 {
    font-size: var(--font-size-2xl);
    font-weight: var(--font-weight-semibold);
}

.modal-close {
    background: none;
    border: none;
    font-size: var(--font-size-3xl);
    cursor: pointer;
    color: var(--color-text-secondary);
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-base);
}

.modal-close:hover {
    background: var(--color-secondary);
    color: var(--color-text);
}

.modal-body {
    padding: var(--space-24);
}

.field-detail {
    padding: var(--space-12) 0;
    border-bottom: 1px solid var(--color-border);
}

.field-detail:last-child {
    border-bottom: none;
}

.field-detail-name {
    font-weight: var(--font-weight-semibold);
    font-size: var(--font-size-base);
    color: var(--color-text);
    margin-bottom: var(--space-4);
}

.field-detail-type {
    font-family: var(--font-family-mono);
    color: var(--color-text-secondary);
    font-size: var(--font-size-sm);
    margin-bottom: var(--space-4);
}

.field-detail-constraint {
    color: var(--color-primary);
    font-size: var(--font-size-sm);
}

.legend {
    position: fixed;
    bottom: var(--space-24);
    right: var(--space-24);
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--space-16);
    box-shadow: var(--shadow-md);
    z-index: 50;
}

.legend h3 {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-semibold);
    margin-bottom: var(--space-12);
}

.legend-item {
    display: flex;
    align-items: center;
    gap: var(--space-8);
    margin-bottom: var(--space-8);
    font-size: var(--font-size-xs);
}

.legend-color {
    width: 20px;
    height: 20px;
    border-radius: var(--radius-sm);
    border: 1px solid var(--color-border);
}

.zoom-controls {
    display: flex;
    gap: var(--space-8);
}

.hidden {
    display: none !important;
}

.table-box.filtered-out {
    opacity: 0.2;
    pointer-events: none;
}
    </style>
</head>
<body>
    <div class="header">
        <h1>ER-диаграмма: Task Management System</h1>
        <div class="controls">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Поиск таблицы...">
            </div>
            <div class="zoom-controls">
                <button class="btn btn-secondary" id="zoomOut">-</button>
                <button class="btn btn-secondary" id="zoomReset">100%</button>
                <button class="btn btn-secondary" id="zoomIn">+</button>
            </div>
            <button class="btn" id="toggleConnections">Скрыть связи</button>
        </div>
    </div>

    <div class="diagram-container">
        <div class="diagram" id="diagram">
            <svg class="connections" id="connections"></svg>
        </div>
    </div>

    <div class="legend">
        <h3>Легенда</h3>
        <div class="legend-item">
            <div class="legend-color" style="background: #E3F2FD;"></div>
            <span>Пользователи</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #C8E6C9;"></div>
            <span>Задачи</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #FFE0B2;"></div>
            <span>Разрешения</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #F8BBD0;"></div>
            <span>Делегирование</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #E1BEE7;"></div>
            <span>Расписание</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #B2DFDB;"></div>
            <span>Супер-проекты</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #FFCDD2;"></div>
            <span>Логирование</span>
        </div>
    </div>

    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle"></h2>
                <button class="modal-close" id="modalClose">&times;</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <script>
        const tables = {
            app_user: {
                color: '#E3F2FD',
                position: { x: 50, y: 50 },
                fields: [
                    { name: 'id', type: 'UUID (PK)', constraint: 'PRIMARY KEY' },
                    { name: 'email', type: 'TEXT', constraint: 'UNIQUE, NOT NULL' },
                    { name: 'display_name', type: 'TEXT', constraint: 'NOT NULL' },
                    { name: 'name', type: 'TEXT', constraint: '' },
                    { name: 'surname', type: 'TEXT', constraint: '' },
                    { name: 'phone', type: 'TEXT', constraint: '' },
                    { name: 'telegram', type: 'TEXT', constraint: '' },
                    { name: 'locale', type: 'TEXT', constraint: '' },
                    { name: 'password_hash', type: 'TEXT', constraint: '' },
                    { name: 'created_at', type: 'TIMESTAMPTZ', constraint: 'NOT NULL, DEFAULT NOW()' },
                    { name: 'updated_at', type: 'TIMESTAMPTZ', constraint: 'NOT NULL, DEFAULT NOW()' }
                ]
            },
            task: {
                color: '#C8E6C9',
                position: { x: 800, y: 50 },
                fields: [
                    { name: 'id', type: 'UUID (PK)', constraint: 'PRIMARY KEY' },
                    { name: 'parent_task_id', type: 'UUID (FK)', constraint: 'FK → task, ON DELETE CASCADE' },
                    { name: 'title', type: 'TEXT', constraint: 'NOT NULL' },
                    { name: 'description', type: 'TEXT', constraint: '' },
                    { name: 'priority', type: 'task_priority_enum', constraint: 'DEFAULT \'normal\'' },
                    { name: 'status', type: 'task_status_enum', constraint: 'DEFAULT \'open\'' },
                    { name: 'estimated_hours', type: 'NUMERIC(10,2)', constraint: 'DEFAULT 0' },
                    { name: 'start_date', type: 'DATE', constraint: '' },
                    { name: 'due_date', type: 'DATE', constraint: '' },
                    { name: 'project_root_id', type: 'UUID', constraint: '' },
                    { name: 'created_by', type: 'UUID (FK)', constraint: 'FK → app_user, NOT NULL' },
                    { name: 'created_at', type: 'TIMESTAMPTZ', constraint: 'NOT NULL' },
                    { name: 'updated_at', type: 'TIMESTAMPTZ', constraint: 'NOT NULL' }
                ]
            },
            task_dependency: {
                color: '#C8E6C9',
                position: { x: 800, y: 500 },
                fields: [
                    { name: 'id', type: 'UUID (PK)', constraint: 'PRIMARY KEY' },
                    { name: 'task_id', type: 'UUID (FK)', constraint: 'FK → task, NOT NULL' },
                    { name: 'depends_on_id', type: 'UUID (FK)', constraint: 'FK → task, NOT NULL' },
                    { name: 'kind', type: 'TEXT', constraint: 'DEFAULT \'finish_start\'' }
                ]
            },
            task_role_assignment: {
                color: '#FFE0B2',
                position: { x: 1200, y: 500 },
                fields: [
                    { name: 'id', type: 'UUID (PK)', constraint: 'PRIMARY KEY' },
                    { name: 'task_id', type: 'UUID (FK)', constraint: 'FK → task, NOT NULL' },
                    { name: 'user_id', type: 'UUID (FK)', constraint: 'FK → app_user, NOT NULL' },
                    { name: 'role', type: 'role_enum', constraint: 'NOT NULL' },
                    { name: 'assigned_at', type: 'TIMESTAMPTZ', constraint: '' }
                ]
            },
            task_assignment: {
                color: '#FFE0B2',
                position: { x: 400, y: 500 },
                fields: [
                    { name: 'id', type: 'UUID (PK)', constraint: 'PRIMARY KEY' },
                    { name: 'task_id', type: 'UUID (FK)', constraint: 'FK → task, NOT NULL' },
                    { name: 'user_id', type: 'UUID (FK)', constraint: 'FK → app_user, NOT NULL' },
                    { name: 'assigned_hours', type: 'NUMERIC(10,2)', constraint: 'DEFAULT 0' },
                    { name: 'assigned_at', type: 'TIMESTAMPTZ', constraint: '' }
                ]
            },
            permission: {
                color: '#FFE0B2',
                position: { x: 1600, y: 50 },
                fields: [
                    { name: 'key', type: 'TEXT (PK)', constraint: 'PRIMARY KEY' },
                    { name: 'description', type: 'TEXT', constraint: 'NOT NULL' },
                    { name: 'is_global', type: 'BOOLEAN', constraint: 'DEFAULT FALSE' }
                ]
            },
            role_permission: {
                color: '#FFE0B2',
                position: { x: 1600, y: 280 },
                fields: [
                    { name: 'id', type: 'UUID (PK)', constraint: 'PRIMARY KEY' },
                    { name: 'role', type: 'role_enum', constraint: 'NOT NULL' },
                    { name: 'permission_key', type: 'TEXT (FK)', constraint: 'FK → permission, NOT NULL' },
                    { name: 'is_global', type: 'BOOLEAN', constraint: '' }
                ]
            },
            global_role_grant: {
                color: '#F8BBD0',
                position: { x: 1600, y: 500 },
                fields: [
                    { name: 'id', type: 'UUID (PK)', constraint: 'PRIMARY KEY' },
                    { name: 'user_id', type: 'UUID (FK)', constraint: 'FK → app_user, NOT NULL' },
                    { name: 'scope_type', type: 'scope_type_enum', constraint: '' },
                    { name: 'scope_id', type: 'UUID (FK)', constraint: 'FK → task' },
                    { name: 'role', type: 'role_enum', constraint: 'NOT NULL' },
                    { name: 'granted_at', type: 'TIMESTAMPTZ', constraint: '' }
                ]
            },
            delegation: {
                color: '#F8BBD0',
                position: { x: 1200, y: 750 },
                fields: [
                    { name: 'id', type: 'UUID (PK)', constraint: 'PRIMARY KEY' },
                    { name: 'task_id', type: 'UUID (FK)', constraint: 'FK → task, NOT NULL' },
                    { name: 'grantor_user_id', type: 'UUID (FK)', constraint: 'FK → app_user, NOT NULL' },
                    { name: 'grantee_user_id', type: 'UUID (FK)', constraint: 'FK → app_user, NOT NULL' },
                    { name: 'status', type: 'delegation_status_enum', constraint: 'DEFAULT \'pending\'' },
                    { name: 'expires_at', type: 'TIMESTAMPTZ', constraint: '' },
                    { name: 'created_at', type: 'TIMESTAMPTZ', constraint: '' },
                    { name: 'activated_at', type: 'TIMESTAMPTZ', constraint: '' },
                    { name: 'revoked_at', type: 'TIMESTAMPTZ', constraint: '' },
                    { name: 'reason', type: 'TEXT', constraint: '' }
                ]
            },
            delegation_permission: {
                color: '#F8BBD0',
                position: { x: 1600, y: 750 },
                fields: [
                    { name: 'id', type: 'UUID (PK)', constraint: 'PRIMARY KEY' },
                    { name: 'delegation_id', type: 'UUID (FK)', constraint: 'FK → delegation, NOT NULL' },
                    { name: 'permission_key', type: 'TEXT (FK)', constraint: 'FK → permission, NOT NULL' },
                    { name: 'allow', type: 'BOOLEAN', constraint: 'DEFAULT TRUE' }
                ]
            },
            user_work_schedule: {
                color: '#E1BEE7',
                position: { x: 50, y: 750 },
                fields: [
                    { name: 'id', type: 'UUID (PK)', constraint: 'PRIMARY KEY' },
                    { name: 'user_id', type: 'UUID (FK)', constraint: 'FK → app_user, NOT NULL' },
                    { name: 'weekday', type: 'INT', constraint: 'CHECK 0..6' },
                    { name: 'start_time', type: 'TIME', constraint: 'NOT NULL' },
                    { name: 'end_time', type: 'TIME', constraint: 'NOT NULL' }
                ]
            },
            task_schedule: {
                color: '#E1BEE7',
                position: { x: 400, y: 1050 },
                fields: [
                    { name: 'id', type: 'UUID (PK)', constraint: 'PRIMARY KEY' },
                    { name: 'task_id', type: 'UUID (FK)', constraint: 'FK → task, NOT NULL' },
                    { name: 'user_id', type: 'UUID (FK)', constraint: 'FK → app_user, NOT NULL' },
                    { name: 'start_ts', type: 'TIMESTAMPTZ', constraint: 'NOT NULL' },
                    { name: 'end_ts', type: 'TIMESTAMPTZ', constraint: 'NOT NULL' },
                    { name: 'hours', type: 'NUMERIC(10,2)', constraint: 'NOT NULL' },
                    { name: 'auto_placed', type: 'BOOLEAN', constraint: 'DEFAULT TRUE' }
                ]
            },
            project_allocation: {
                color: '#E1BEE7',
                position: { x: 50, y: 1050 },
                fields: [
                    { name: 'id', type: 'UUID (PK)', constraint: 'PRIMARY KEY' },
                    { name: 'project_id', type: 'UUID (FK)', constraint: 'FK → task, NOT NULL' },
                    { name: 'user_id', type: 'UUID (FK)', constraint: 'FK → app_user, NOT NULL' },
                    { name: 'weekday', type: 'INT', constraint: 'CHECK 0..6' },
                    { name: 'start_time', type: 'TIME', constraint: 'NOT NULL' },
                    { name: 'end_time', type: 'TIME', constraint: 'NOT NULL' },
                    { name: 'hours_per_day', type: 'NUMERIC(10,2)', constraint: '' }
                ]
            },
            super_project: {
                color: '#B2DFDB',
                position: { x: 1200, y: 50 },
                fields: [
                    { name: 'id', type: 'UUID (PK)', constraint: 'PRIMARY KEY' },
                    { name: 'name', type: 'TEXT', constraint: 'NOT NULL' },
                    { name: 'description', type: 'TEXT', constraint: '' },
                    { name: 'created_at', type: 'TIMESTAMPTZ', constraint: '' }
                ]
            },
            super_project_link: {
                color: '#B2DFDB',
                position: { x: 1200, y: 280 },
                fields: [
                    { name: 'id', type: 'UUID (PK)', constraint: 'PRIMARY KEY' },
                    { name: 'super_project_id', type: 'UUID (FK)', constraint: 'FK → super_project, NOT NULL' },
                    { name: 'project_id', type: 'UUID (FK)', constraint: 'FK → task, NOT NULL' }
                ]
            },
            audit_log: {
                color: '#FFCDD2',
                position: { x: 800, y: 1050 },
                fields: [
                    { name: 'id', type: 'UUID (PK)', constraint: 'PRIMARY KEY' },
                    { name: 'timestamp', type: 'TIMESTAMPTZ', constraint: 'DEFAULT NOW()' },
                    { name: 'actor_user_id', type: 'UUID (FK)', constraint: 'FK → app_user' },
                    { name: 'action_type', type: 'TEXT', constraint: 'NOT NULL' },
                    { name: 'object_type', type: 'TEXT', constraint: 'NOT NULL' },
                    { name: 'object_id', type: 'UUID', constraint: '' },
                    { name: 'project_id', type: 'UUID', constraint: '' },
                    { name: 'details', type: 'JSONB', constraint: '' },
                    { name: 'ip', type: 'INET', constraint: '' },
                    { name: 'user_agent', type: 'TEXT', constraint: '' }
                ]
            },
            conflict_resolution: {
                color: '#FFCDD2',
                position: { x: 1200, y: 1050 },
                fields: [
                    { name: 'id', type: 'UUID (PK)', constraint: 'PRIMARY KEY' },
                    { name: 'project_id', type: 'UUID (FK)', constraint: 'FK → task, NOT NULL' },
                    { name: 'task_id', type: 'UUID (FK)', constraint: 'FK → task, NOT NULL' },
                    { name: 'target_user_id', type: 'UUID (FK)', constraint: 'FK → app_user' },
                    { name: 'kind', type: 'resolution_kind_enum', constraint: 'NOT NULL' },
                    { name: 'payload', type: 'JSONB', constraint: 'NOT NULL' },
                    { name: 'status', type: 'resolution_status_enum', constraint: 'DEFAULT \'suggested\'' },
                    { name: 'suggested_by', type: 'UUID', constraint: '' },
                    { name: 'suggested_at', type: 'TIMESTAMPTZ', constraint: '' },
                    { name: 'decided_by', type: 'UUID', constraint: '' },
                    { name: 'decided_at', type: 'TIMESTAMPTZ', constraint: '' }
                ]
            }
        };

        const connections = [
            { from: 'task', to: 'app_user', field: 'created_by', required: true },
            { from: 'task', to: 'task', field: 'parent_task_id', required: false },
            { from: 'task_dependency', to: 'task', field: 'task_id', required: true },
            { from: 'task_dependency', to: 'task', field: 'depends_on_id', required: true },
            { from: 'task_role_assignment', to: 'task', field: 'task_id', required: true },
            { from: 'task_role_assignment', to: 'app_user', field: 'user_id', required: true },
            { from: 'task_assignment', to: 'task', field: 'task_id', required: true },
            { from: 'task_assignment', to: 'app_user', field: 'user_id', required: true },
            { from: 'role_permission', to: 'permission', field: 'permission_key', required: true },
            { from: 'global_role_grant', to: 'app_user', field: 'user_id', required: true },
            { from: 'global_role_grant', to: 'task', field: 'scope_id', required: false },
            { from: 'delegation', to: 'task', field: 'task_id', required: true },
            { from: 'delegation', to: 'app_user', field: 'grantor_user_id', required: true },
            { from: 'delegation', to: 'app_user', field: 'grantee_user_id', required: true },
            { from: 'delegation_permission', to: 'delegation', field: 'delegation_id', required: true },
            { from: 'delegation_permission', to: 'permission', field: 'permission_key', required: true },
            { from: 'user_work_schedule', to: 'app_user', field: 'user_id', required: true },
            { from: 'task_schedule', to: 'task', field: 'task_id', required: true },
            { from: 'task_schedule', to: 'app_user', field: 'user_id', required: true },
            { from: 'project_allocation', to: 'task', field: 'project_id', required: true },
            { from: 'project_allocation', to: 'app_user', field: 'user_id', required: true },
            { from: 'super_project_link', to: 'super_project', field: 'super_project_id', required: true },
            { from: 'super_project_link', to: 'task', field: 'project_id', required: true },
            { from: 'audit_log', to: 'app_user', field: 'actor_user_id', required: false },
            { from: 'conflict_resolution', to: 'task', field: 'project_id', required: true },
            { from: 'conflict_resolution', to: 'task', field: 'task_id', required: true },
            { from: 'conflict_resolution', to: 'app_user', field: 'target_user_id', required: false }
        ];

        let zoomLevel = 1;
        let showConnections = true;
        const diagram = document.getElementById('diagram');
        const svg = document.getElementById('connections');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const modalClose = document.getElementById('modalClose');
        const searchInput = document.getElementById('searchInput');
        const toggleConnectionsBtn = document.getElementById('toggleConnections');

        function renderTables() {
            Object.keys(tables).forEach(tableName => {
                const table = tables[tableName];
                const tableBox = document.createElement('div');
                tableBox.className = 'table-box';
                tableBox.dataset.table = tableName;
                tableBox.style.left = table.position.x + 'px';
                tableBox.style.top = table.position.y + 'px';

                const header = document.createElement('div');
                header.className = 'table-header';
                header.style.backgroundColor = table.color;
                header.textContent = tableName;
                tableBox.appendChild(header);

                const body = document.createElement('div');
                body.className = 'table-body';

                const fieldsToShow = table.fields.slice(0, 6);
                fieldsToShow.forEach(field => {
                    const fieldDiv = document.createElement('div');
                    fieldDiv.className = 'field';
                    fieldDiv.innerHTML = `
                        <span class="field-name">${field.name}</span>
                        <span class="field-type">${field.type}</span>
                        ${field.constraint ? `<br><span class="field-constraint">${field.constraint}</span>` : ''}
                    `;
                    body.appendChild(fieldDiv);
                });

                if (table.fields.length > 6) {
                    const moreDiv = document.createElement('div');
                    moreDiv.className = 'field';
                    moreDiv.style.fontStyle = 'italic';
                    moreDiv.style.color = 'var(--color-text-secondary)';
                    moreDiv.textContent = `... и еще ${table.fields.length - 6} полей`;
                    body.appendChild(moreDiv);
                }

                tableBox.appendChild(body);
                tableBox.addEventListener('click', () => showModal(tableName));
                diagram.appendChild(tableBox);
            });
        }

        function getTableCenter(tableName) {
            const table = tables[tableName];
            const box = document.querySelector(`[data-table="${tableName}"]`);
            if (!box) return { x: 0, y: 0 };
            return {
                x: table.position.x + box.offsetWidth / 2,
                y: table.position.y + box.offsetHeight / 2
            };
        }

        function drawConnections() {
            svg.innerHTML = '';
            if (!showConnections) return;

            connections.forEach(conn => {
                const from = getTableCenter(conn.from);
                const to = getTableCenter(conn.to);

                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                const dx = to.x - from.x;
                const dy = to.y - from.y;
                const midX = from.x + dx / 2;

                const d = `M ${from.x} ${from.y} Q ${midX} ${from.y}, ${midX} ${from.y + dy / 2} T ${to.x} ${to.y}`;
                path.setAttribute('d', d);
                path.setAttribute('class', `connection-line ${conn.required ? '' : 'optional'}`);
                svg.appendChild(path);

                const arrowSize = 8;
                const angle = Math.atan2(dy, dx);
                const arrowPoints = [
                    { x: to.x, y: to.y },
                    { x: to.x - arrowSize * Math.cos(angle - Math.PI / 6), y: to.y - arrowSize * Math.sin(angle - Math.PI / 6) },
                    { x: to.x - arrowSize * Math.cos(angle + Math.PI / 6), y: to.y - arrowSize * Math.sin(angle + Math.PI / 6) }
                ];
                const arrow = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
                arrow.setAttribute('points', arrowPoints.map(p => `${p.x},${p.y}`).join(' '));
                arrow.setAttribute('class', 'connection-arrow');
                svg.appendChild(arrow);
            });
        }

        function showModal(tableName) {
            const table = tables[tableName];
            modalTitle.textContent = tableName;
            modalBody.innerHTML = '';

            table.fields.forEach(field => {
                const fieldDetail = document.createElement('div');
                fieldDetail.className = 'field-detail';
                fieldDetail.innerHTML = `
                    <div class="field-detail-name">${field.name}</div>
                    <div class="field-detail-type">${field.type}</div>
                    ${field.constraint ? `<div class="field-detail-constraint">${field.constraint}</div>` : ''}
                `;
                modalBody.appendChild(fieldDetail);
            });

            modal.classList.add('active');
        }

        function closeModal() {
            modal.classList.remove('active');
        }

        function handleZoom(delta) {
            zoomLevel = Math.max(0.5, Math.min(2, zoomLevel + delta));
            diagram.style.transform = `scale(${zoomLevel})`;
            document.getElementById('zoomReset').textContent = `${Math.round(zoomLevel * 100)}%`;
        }

        function handleSearch(query) {
            const lowerQuery = query.toLowerCase();
            document.querySelectorAll('.table-box').forEach(box => {
                const tableName = box.dataset.table.toLowerCase();
                if (tableName.includes(lowerQuery) || query === '') {
                    box.classList.remove('filtered-out');
                } else {
                    box.classList.add('filtered-out');
                }
            });
        }

        function toggleConnectionsVisibility() {
            showConnections = !showConnections;
            toggleConnectionsBtn.textContent = showConnections ? 'Скрыть связи' : 'Показать связи';
            drawConnections();
        }

        modalClose.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });

        document.getElementById('zoomIn').addEventListener('click', () => handleZoom(0.1));
        document.getElementById('zoomOut').addEventListener('click', () => handleZoom(-0.1));
        document.getElementById('zoomReset').addEventListener('click', () => {
            zoomLevel = 1;
            diagram.style.transform = 'scale(1)';
            document.getElementById('zoomReset').textContent = '100%';
        });

        searchInput.addEventListener('input', (e) => handleSearch(e.target.value));
        toggleConnectionsBtn.addEventListener('click', toggleConnectionsVisibility);

        renderTables();
        setTimeout(() => drawConnections(), 100);
    </script>
</body>
</html>
