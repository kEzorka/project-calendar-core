openapi: 3.0.3
info:
  title: Project Calendar API
  description: |
    REST API для системы управления проектами и задачами с календарём.
    
    **Основные возможности:**
    - Аутентификация через JWT
    - Иерархия задач (любая задача может иметь подзадачи)
    - Система ролей и прав (owner, supervisor, executor, hybrid, spectator)
    - Делегирование прав между пользователями
    - Календарное планирование с рабочим расписанием
    - Назначение пользователей на задачи с указанием часов
    
    **Архитектура задач:**
    - Проект = задача без родителя (parent_task_id = NULL)
    - Любая задача может иметь подзадачи через parent_task_id
    - Иерархия неограниченной глубины
  version: 1.0.0-mvp
  contact:
    name: Project Calendar Team
    url: https://github.com/kEzorka/project-calendar-core
    email: support@project-calendar.dev
  license:
    name: MIT

servers:
  - url: http://localhost:8080
    description: Development server
  - url: https://api.project-calendar.dev
    description: Production server (future)

tags:
  - name: auth
    description: Аутентификация и управление пользователями
  - name: tasks
    description: Управление задачами (включая проекты)
  - name: members
    description: Управление участниками задач
  - name: assignments
    description: Назначение пользователей на задачи
  - name: calendar
    description: Календарь и расписание
  - name: work-schedule
    description: Рабочее расписание пользователей
  - name: delegations
    description: Делегирование прав

security:
  - bearerAuth: []

paths:
  # ==================== AUTHENTICATION ====================
  /api/auth/register:
    post:
      tags: [auth]
      summary: Регистрация нового пользователя
      description: Создание учётной записи с email и паролем
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
                - displayName
              properties:
                email:
                  type: string
                  format: email
                  maxLength: 254
                  example: ivan.ivanov@example.com
                password:
                  type: string
                  format: password
                  minLength: 8
                  example: SecurePass123
                displayName:
                  type: string
                  minLength: 2
                  maxLength: 100
                  example: Иван Иванов
                name:
                  type: string
                  maxLength: 50
                  example: Иван
                surname:
                  type: string
                  maxLength: 50
                  example: Иванов
      responses:
        '201':
          description: Пользователь успешно зарегистрирован
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  userId:
                    type: string
                    format: uuid
                    example: 550e8400-e29b-41d4-a716-446655440000
                  message:
                    type: string
                    example: User registered successfully
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          description: Email уже используется
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                success: false
                message: Email already exists
                code: EMAIL_EXISTS

  /api/auth/login:
    post:
      tags: [auth]
      summary: Вход в систему
      description: Аутентификация пользователя и получение JWT токена
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                  example: ivan.ivanov@example.com
                password:
                  type: string
                  format: password
                  example: SecurePass123
      responses:
        '200':
          description: Успешная аутентификация
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  token:
                    type: string
                    description: JWT токен (действителен 24 часа)
                    example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                  user:
                    $ref: '#/components/schemas/User'
        '401':
          description: Неверные учётные данные
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                success: false
                message: Invalid credentials
                code: INVALID_CREDENTIALS

  /api/auth/me:
    get:
      tags: [auth]
      summary: Получить данные текущего пользователя
      description: Возвращает информацию о пользователе на основе JWT токена
      responses:
        '200':
          description: Данные пользователя
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  # ==================== TASKS (включая проекты) ====================
  /api/tasks:
    get:
      tags: [tasks]
      summary: Список задач
      description: |
        Получение списка задач с фильтрацией.
        
        **Получение проектов (задач верхнего уровня):**
        - `GET /api/tasks?parent_id=null`
        
        **Получение подзадач:**
        - `GET /api/tasks?parent_id={taskId}`
        
        **Фильтрация:**
        - По статусу, приоритету, участнику
      parameters:
        - name: parent_id
          in: query
          description: |
            ID родительской задачи.
            - `null` или отсутствует = все задачи пользователя
            - UUID = подзадачи конкретной задачи
          schema:
            type: string
            nullable: true
          example: null
        - name: status
          in: query
          description: Фильтр по статусу
          schema:
            $ref: '#/components/schemas/TaskStatus'
        - name: priority
          in: query
          description: Фильтр по приоритету
          schema:
            $ref: '#/components/schemas/TaskPriority'
        - name: assigned_to
          in: query
          description: Фильтр по назначенному пользователю (UUID)
          schema:
            type: string
            format: uuid
        - $ref: '#/components/parameters/Page'
        - $ref: '#/components/parameters/Limit'
      responses:
        '200':
          description: Список задач
          content:
            application/json:
              schema:
                type: object
                properties:
                  tasks:
                    type: array
                    items:
                      $ref: '#/components/schemas/Task'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      tags: [tasks]
      summary: Создать задачу
      description: |
        Создание новой задачи.
        
        **Создание проекта (задачи верхнего уровня):**
        - Не указывать `parent_task_id` или указать `null`
        - Текущий пользователь автоматически станет owner
        
        **Создание подзадачи:**
        - Указать `parent_task_id` существующей задачи
        - Требуется право `task.create.local`
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TaskCreate'
            examples:
              project:
                summary: Создание проекта
                value:
                  title: Разработка веб-приложения
                  description: Корпоративный портал с личным кабинетом
                  priority: high
                  estimated_hours: 480
                  start_date: "2025-02-01"
                  due_date: "2025-04-30"
              subtask:
                summary: Создание подзадачи
                value:
                  parent_task_id: 550e8400-e29b-41d4-a716-446655440000
                  title: Разработать API аутентификации
                  description: JWT токены, регистрация, вход
                  priority: high
                  estimated_hours: 16
                  start_date: "2025-02-01"
                  due_date: "2025-02-05"
      responses:
        '201':
          description: Задача создана
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Task'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /api/tasks/{taskId}:
    parameters:
      - $ref: '#/components/parameters/TaskId'
    
    get:
      tags: [tasks]
      summary: Получить детали задачи
      description: |
        Детальная информация о задаче, включая:
        - Основные поля
        - Список участников (members)
        - Назначенные пользователи (assignments)
        - Количество подзадач
        - Статистика по подзадачам
      responses:
        '200':
          description: Детали задачи
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/Task'
                  - type: object
                    properties:
                      members:
                        type: array
                        items:
                          $ref: '#/components/schemas/Member'
                      assignments:
                        type: array
                        items:
                          $ref: '#/components/schemas/Assignment'
                      subtasks_count:
                        type: integer
                        example: 12
                      subtasks_stats:
                        type: object
                        properties:
                          open:
                            type: integer
                            example: 5
                          in_progress:
                            type: integer
                            example: 4
                          review:
                            type: integer
                            example: 2
                          completed:
                            type: integer
                            example: 1
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
    
    put:
      tags: [tasks]
      summary: Обновить задачу
      description: |
        Обновление полей задачи.
        Требуется право `task.update.local`
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TaskUpdate'
      responses:
        '200':
          description: Задача обновлена
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Task'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
    
    delete:
      tags: [tasks]
      summary: Удалить задачу
      description: |
        Удаление задачи и всех её подзадач (CASCADE).
        Требуется право `task.delete.local` (только owner)
      responses:
        '204':
          description: Задача удалена
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/tasks/{taskId}/status:
    parameters:
      - $ref: '#/components/parameters/TaskId'
    
    put:
      tags: [tasks]
      summary: Изменить статус задачи
      description: |
        Изменение статуса задачи.
        Требуется право `task.change_status.local` (executor может менять)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - status
              properties:
                status:
                  $ref: '#/components/schemas/TaskStatus'
      responses:
        '200':
          description: Статус изменён
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Task'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  # ==================== MEMBERS ====================
  /api/tasks/{taskId}/members:
    parameters:
      - $ref: '#/components/parameters/TaskId'
    
    get:
      tags: [members]
      summary: Список участников задачи
      description: Получение списка участников с их ролями
      responses:
        '200':
          description: Список участников
          content:
            application/json:
              schema:
                type: object
                properties:
                  members:
                    type: array
                    items:
                      $ref: '#/components/schemas/Member'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
    
    post:
      tags: [members]
      summary: Добавить участника
      description: |
        Добавление участника в задачу с назначением роли.
        Требуется быть owner или supervisor
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - user_id
                - role
              properties:
                user_id:
                  type: string
                  format: uuid
                  example: 660e8400-e29b-41d4-a716-446655440001
                role:
                  $ref: '#/components/schemas/Role'
      responses:
        '201':
          description: Участник добавлен
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Member'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          description: Пользователь уже участник
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/tasks/{taskId}/members/{userId}:
    parameters:
      - $ref: '#/components/parameters/TaskId'
      - $ref: '#/components/parameters/UserId'
    
    put:
      tags: [members]
      summary: Изменить роль участника
      description: |
        Изменение роли участника.
        Требуется быть owner.
        Нельзя изменить роль единственного owner
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - role
              properties:
                role:
                  $ref: '#/components/schemas/Role'
      responses:
        '200':
          description: Роль изменена
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Member'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
    
    delete:
      tags: [members]
      summary: Удалить участника
      description: |
        Удаление участника из задачи.
        Требуется быть owner.
        Нельзя удалить последнего owner
      responses:
        '204':
          description: Участник удалён
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  # ==================== ASSIGNMENTS ====================
  /api/tasks/{taskId}/assignments:
    parameters:
      - $ref: '#/components/parameters/TaskId'
    
    get:
      tags: [assignments]
      summary: Список назначений на задачу
      description: Получение списка назначенных пользователей с часами
      responses:
        '200':
          description: Список назначений
          content:
            application/json:
              schema:
                type: object
                properties:
                  assignments:
                    type: array
                    items:
                      $ref: '#/components/schemas/Assignment'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
    
    post:
      tags: [assignments]
      summary: Назначить пользователя на задачу
      description: |
        Назначение пользователя с указанием часов.
        Требуется право `assignment.assign.local`
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - user_id
                - assigned_hours
              properties:
                user_id:
                  type: string
                  format: uuid
                  example: 660e8400-e29b-41d4-a716-446655440001
                assigned_hours:
                  type: number
                  format: double
                  minimum: 0
                  maximum: 1000
                  example: 16
      responses:
        '201':
          description: Пользователь назначен
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Assignment'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/assignments/{assignmentId}:
    parameters:
      - name: assignmentId
        in: path
        required: true
        schema:
          type: string
          format: uuid
    
    put:
      tags: [assignments]
      summary: Обновить назначение
      description: Обновление количества часов
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - assigned_hours
              properties:
                assigned_hours:
                  type: number
                  format: double
                  minimum: 0
                  maximum: 1000
                  example: 24
      responses:
        '200':
          description: Назначение обновлено
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Assignment'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
    
    delete:
      tags: [assignments]
      summary: Удалить назначение
      description: Удаление назначения пользователя с задачи
      responses:
        '204':
          description: Назначение удалено
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  # ==================== CALENDAR ====================
  /api/calendar:
    get:
      tags: [calendar]
      summary: Просмотр календаря
      description: |
        Получение расписания задач за указанный период.
        Возвращает временные интервалы из task_schedule
      parameters:
        - name: user_id
          in: query
          description: ID пользователя (по умолчанию - текущий)
          schema:
            type: string
            format: uuid
        - name: from
          in: query
          required: true
          description: Начало периода (включительно)
          schema:
            type: string
            format: date
            example: "2025-02-01"
        - name: to
          in: query
          required: true
          description: Конец периода (включительно)
          schema:
            type: string
            format: date
            example: "2025-02-07"
      responses:
        '200':
          description: Расписание за период
          content:
            application/json:
              schema:
                type: object
                properties:
                  user_id:
                    type: string
                    format: uuid
                  display_name:
                    type: string
                  period:
                    type: object
                    properties:
                      from:
                        type: string
                        format: date
                      to:
                        type: string
                        format: date
                  schedule:
                    type: array
                    items:
                      $ref: '#/components/schemas/ScheduleEntry'
                  work_schedule:
                    type: array
                    items:
                      $ref: '#/components/schemas/WorkScheduleEntry'
                  total_hours:
                    type: number
                    format: double
                    example: 40
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  # ==================== WORK SCHEDULE ====================
  /api/users/me/work-schedule:
    get:
      tags: [work-schedule]
      summary: Получить моё рабочее расписание
      description: Рабочие часы по дням недели
      responses:
        '200':
          description: Рабочее расписание
          content:
            application/json:
              schema:
                type: object
                properties:
                  schedule:
                    type: array
                    items:
                      $ref: '#/components/schemas/WorkScheduleEntry'
                  total_week_hours:
                    type: number
                    format: double
                    example: 40
        '401':
          $ref: '#/components/responses/Unauthorized'
    
    post:
      tags: [work-schedule]
      summary: Установить рабочее расписание
      description: Создание/обновление рабочего расписания (UPSERT)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - schedule
              properties:
                schedule:
                  type: array
                  items:
                    type: object
                    required:
                      - weekday
                      - start_time
                      - end_time
                    properties:
                      weekday:
                        type: integer
                        minimum: 0
                        maximum: 6
                        description: 0=Воскресенье, 1=Понедельник, ..., 6=Суббота
                        example: 1
                      start_time:
                        type: string
                        format: time
                        example: "09:00"
                      end_time:
                        type: string
                        format: time
                        example: "18:00"
      responses:
        '200':
          description: Расписание установлено
          content:
            application/json:
              schema:
                type: object
                properties:
                  schedule:
                    type: array
                    items:
                      $ref: '#/components/schemas/WorkScheduleEntry'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/users/me/work-schedule/{weekday}:
    parameters:
      - name: weekday
        in: path
        required: true
        schema:
          type: integer
          minimum: 0
          maximum: 6
    
    put:
      tags: [work-schedule]
      summary: Обновить рабочий день
      description: Обновление времени работы для конкретного дня недели
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - start_time
                - end_time
              properties:
                start_time:
                  type: string
                  format: time
                  example: "09:00"
                end_time:
                  type: string
                  format: time
                  example: "18:00"
      responses:
        '200':
          description: День обновлён
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkScheduleEntry'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
    
    delete:
      tags: [work-schedule]
      summary: Удалить рабочий день
      description: Удаление расписания для конкретного дня
      responses:
        '204':
          description: День удалён
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  # ==================== DELEGATIONS ====================
  /api/delegations:
    post:
      tags: [delegations]
      summary: Создать запрос на делегирование
      description: |
        Создание запроса на делегирование прав другому пользователю.
        Статус создаётся как "pending", требуется одобрение owner/supervisor
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - task_id
                - grantee_user_id
                - permissions
                - expires_at
              properties:
                task_id:
                  type: string
                  format: uuid
                  description: ID задачи (обычно корневой для делегирования на проект)
                grantee_user_id:
                  type: string
                  format: uuid
                  description: Кому делегируются права
                permissions:
                  type: array
                  items:
                    type: string
                  example:
                    - task.update.local
                    - task.change_status.local
                expires_at:
                  type: string
                  format: date-time
                  description: Когда делегирование истекает
                  example: "2025-02-28T23:59:59Z"
                reason:
                  type: string
                  maxLength: 500
                  example: "Отпуск с 1 по 28 февраля"
      responses:
        '201':
          description: Запрос создан
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Delegation'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /api/tasks/{taskId}/delegations:
    parameters:
      - $ref: '#/components/parameters/TaskId'
    
    get:
      tags: [delegations]
      summary: Список делегирований задачи
      description: Получение списка всех делегирований для задачи
      parameters:
        - name: status
          in: query
          schema:
            $ref: '#/components/schemas/DelegationStatus'
        - name: grantee_user_id
          in: query
          schema:
            type: string
            format: uuid
        - name: grantor_user_id
          in: query
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Список делегирований
          content:
            application/json:
              schema:
                type: object
                properties:
                  delegations:
                    type: array
                    items:
                      $ref: '#/components/schemas/Delegation'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /api/delegations/{delegationId}:
    parameters:
      - name: delegationId
        in: path
        required: true
        schema:
          type: string
          format: uuid
    
    get:
      tags: [delegations]
      summary: Детали делегирования
      description: Получение подробной информации о делегировании
      responses:
        '200':
          description: Детали делегирования
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Delegation'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/delegations/{delegationId}/approve:
    parameters:
      - name: delegationId
        in: path
        required: true
        schema:
          type: string
          format: uuid
    
    put:
      tags: [delegations]
      summary: Одобрить делегирование
      description: |
        Одобрение запроса на делегирование.
        Требуется быть owner или supervisor задачи.
        Статус меняется на "active"
      responses:
        '200':
          description: Делегирование одобрено
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Delegation'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/delegations/{delegationId}/reject:
    parameters:
      - name: delegationId
        in: path
        required: true
        schema:
          type: string
          format: uuid
    
    put:
      tags: [delegations]
      summary: Отклонить делегирование
      description: |
        Отклонение запроса на делегирование.
        Требуется быть owner или supervisor.
        Статус меняется на "rejected"
      responses:
        '200':
          description: Делегирование отклонено
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Delegation'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/delegations/{delegationId}/revoke:
    parameters:
      - name: delegationId
        in: path
        required: true
        schema:
          type: string
          format: uuid
    
    put:
      tags: [delegations]
      summary: Отозвать делегирование
      description: |
        Отзыв активного делегирования.
        Может выполнить grantor или owner.
        Статус меняется на "revoked"
      responses:
        '200':
          description: Делегирование отозвано
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Delegation'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/users/me/delegations:
    get:
      tags: [delegations]
      summary: Мои делегирования
      description: |
        Получение делегирований текущего пользователя.
        - `type=received` - делегирования, где я grantee
        - `type=granted` - делегирования, где я grantor
        - без type - оба типа
      parameters:
        - name: type
          in: query
          schema:
            type: string
            enum: [received, granted]
        - name: status
          in: query
          schema:
            $ref: '#/components/schemas/DelegationStatus'
      responses:
        '200':
          description: Список делегирований
          content:
            application/json:
              schema:
                type: object
                properties:
                  delegations:
                    type: array
                    items:
                      $ref: '#/components/schemas/Delegation'
        '401':
          $ref: '#/components/responses/Unauthorized'

# ==================== COMPONENTS ====================
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT токен, получаемый при логине. Действителен 24 часа.

  parameters:
    TaskId:
      name: taskId
      in: path
      required: true
      description: ID задачи (UUID)
      schema:
        type: string
        format: uuid
      example: 550e8400-e29b-41d4-a716-446655440000
    
    UserId:
      name: userId
      in: path
      required: true
      description: ID пользователя (UUID)
      schema:
        type: string
        format: uuid
      example: 660e8400-e29b-41d4-a716-446655440001
    
    Page:
      name: page
      in: query
      description: Номер страницы (начиная с 1)
      schema:
        type: integer
        minimum: 1
        default: 1
      example: 1
    
    Limit:
      name: limit
      in: query
      description: Количество элементов на странице
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 20
      example: 20

  schemas:
    # ===== USER =====
    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: 660e8400-e29b-41d4-a716-446655440001
        email:
          type: string
          format: email
          example: ivan.ivanov@example.com
        display_name:
          type: string
          example: Иван Иванов
        name:
          type: string
          example: Иван
        surname:
          type: string
          example: Иванов
        created_at:
          type: string
          format: date-time
          example: "2025-01-15T10:30:00Z"

    # ===== TASK =====
    Task:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: 550e8400-e29b-41d4-a716-446655440000
        parent_task_id:
          type: string
          format: uuid
          nullable: true
          description: ID родительской задачи (null для проектов верхнего уровня)
          example: null
        title:
          type: string
          example: Разработка веб-приложения
        description:
          type: string
          nullable: true
          example: Корпоративный портал с личным кабинетом
        priority:
          $ref: '#/components/schemas/TaskPriority'
        status:
          $ref: '#/components/schemas/TaskStatus'
        estimated_hours:
          type: number
          format: double
          example: 480
        start_date:
          type: string
          format: date
          nullable: true
          example: "2025-02-01"
        due_date:
          type: string
          format: date
          nullable: true
          example: "2025-04-30"
        created_by:
          type: string
          format: uuid
          example: 660e8400-e29b-41d4-a716-446655440001
        created_at:
          type: string
          format: date-time
          example: "2025-01-20T14:30:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2025-01-20T14:30:00Z"
    
    TaskCreate:
      type: object
      required:
        - title
      properties:
        parent_task_id:
          type: string
          format: uuid
          nullable: true
          description: ID родительской задачи (null или не указывать для проекта)
        title:
          type: string
          minLength: 3
          maxLength: 200
          example: Разработать API аутентификации
        description:
          type: string
          maxLength: 2000
          example: JWT токены, регистрация, вход
        priority:
          $ref: '#/components/schemas/TaskPriority'
        estimated_hours:
          type: number
          format: double
          minimum: 0
          maximum: 10000
          example: 16
        start_date:
          type: string
          format: date
          example: "2025-02-01"
        due_date:
          type: string
          format: date
          example: "2025-02-05"
    
    TaskUpdate:
      type: object
      properties:
        title:
          type: string
          minLength: 3
          maxLength: 200
        description:
          type: string
          maxLength: 2000
        priority:
          $ref: '#/components/schemas/TaskPriority'
        estimated_hours:
          type: number
          format: double
          minimum: 0
          maximum: 10000
        start_date:
          type: string
          format: date
        due_date:
          type: string
          format: date
    
    TaskPriority:
      type: string
      enum:
        - low
        - normal
        - high
        - critical
      example: high
    
    TaskStatus:
      type: string
      enum:
        - open
        - in_progress
        - review
        - completed
        - cancelled
      example: in_progress

    # ===== MEMBER =====
    Member:
      type: object
      properties:
        user_id:
          type: string
          format: uuid
          example: 660e8400-e29b-41d4-a716-446655440001
        email:
          type: string
          format: email
          example: ivan.ivanov@example.com
        display_name:
          type: string
          example: Иван Иванов
        role:
          $ref: '#/components/schemas/Role'
        assigned_at:
          type: string
          format: date-time
          example: "2025-01-20T15:00:00Z"
        assigned_tasks_count:
          type: integer
          description: Количество назначенных задач на этого участника
          example: 5
    
    Role:
      type: string
      enum:
        - owner
        - supervisor
        - executor
        - hybrid
        - spectator
      description: |
        - **owner** - владелец, все права
        - **supervisor** - руководитель, создаёт задачи и назначает
        - **executor** - исполнитель, меняет статус своих задач
        - **hybrid** - гибрид supervisor + executor
        - **spectator** - наблюдатель, только просмотр
      example: supervisor

    # ===== ASSIGNMENT =====
    Assignment:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: 770e8400-e29b-41d4-a716-446655440002
        task_id:
          type: string
          format: uuid
          example: 550e8400-e29b-41d4-a716-446655440000
        user_id:
          type: string
          format: uuid
          example: 660e8400-e29b-41d4-a716-446655440001
        display_name:
          type: string
          example: Иван Иванов
        assigned_hours:
          type: number
          format: double
          example: 16
        assigned_at:
          type: string
          format: date-time
          example: "2025-01-21T09:00:00Z"

    # ===== SCHEDULE =====
    ScheduleEntry:
      type: object
      properties:
        id:
          type: string
          format: uuid
        task_id:
          type: string
          format: uuid
          example: 550e8400-e29b-41d4-a716-446655440000
        task_title:
          type: string
          example: Разработать API аутентификации
        task_parent_title:
          type: string
          description: Название родительской задачи (проекта)
          example: Разработка веб-приложения
        start_ts:
          type: string
          format: date-time
          example: "2025-02-01T09:00:00Z"
        end_ts:
          type: string
          format: date-time
          example: "2025-02-01T17:00:00Z"
        hours:
          type: number
          format: double
          example: 8
        auto_placed:
          type: boolean
          description: Автоматически размещено или вручную
          example: true
    
    WorkScheduleEntry:
      type: object
      properties:
        id:
          type: string
          format: uuid
        weekday:
          type: integer
          minimum: 0
          maximum: 6
          description: 0=Воскресенье, 1=Понедельник, ..., 6=Суббота
          example: 1
        weekday_name:
          type: string
          example: Понедельник
        start_time:
          type: string
          format: time
          example: "09:00"
        end_time:
          type: string
          format: time
          example: "18:00"
        total_hours:
          type: number
          format: double
          example: 8

    # ===== DELEGATION =====
    Delegation:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: 880e8400-e29b-41d4-a716-446655440003
        task_id:
          type: string
          format: uuid
          example: 550e8400-e29b-41d4-a716-446655440000
        grantor_user_id:
          type: string
          format: uuid
          description: Кто делегирует
          example: 660e8400-e29b-41d4-a716-446655440001
        grantor_display_name:
          type: string
          example: Иван Иванов
        grantee_user_id:
          type: string
          format: uuid
          description: Кому делегируется
          example: 660e8400-e29b-41d4-a716-446655440002
        grantee_display_name:
          type: string
          example: Пётр Петров
        status:
          $ref: '#/components/schemas/DelegationStatus'
        permissions:
          type: array
          items:
            type: string
          example:
            - task.update.local
            - task.change_status.local
        expires_at:
          type: string
          format: date-time
          example: "2025-02-28T23:59:59Z"
        created_at:
          type: string
          format: date-time
          example: "2025-01-25T10:00:00Z"
        activated_at:
          type: string
          format: date-time
          nullable: true
          example: "2025-01-25T11:00:00Z"
        revoked_at:
          type: string
          format: date-time
          nullable: true
          example: null
        reason:
          type: string
          example: "Отпуск с 1 по 28 февраля"
    
    DelegationStatus:
      type: string
      enum:
        - pending
        - active
        - rejected
        - revoked
        - expired
      example: active

    # ===== PAGINATION =====
    Pagination:
      type: object
      properties:
        page:
          type: integer
          example: 1
        limit:
          type: integer
          example: 20
        total:
          type: integer
          description: Общее количество элементов
          example: 45

    # ===== ERROR =====
    Error:
      type: object
      properties:
        success:
          type: boolean
          example: false
        message:
          type: string
          example: Invalid request parameters
        code:
          type: string
          description: Код ошибки для программной обработки
          example: INVALID_PARAMETERS

  responses:
    BadRequest:
      description: Некорректный запрос (валидация не прошла)
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            success: false
            message: Invalid request parameters
            code: VALIDATION_ERROR
    
    Unauthorized:
      description: Требуется аутентификация (отсутствует или невалидный JWT токен)
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            success: false
            message: Invalid or expired token
            code: UNAUTHORIZED
    
    Forbidden:
      description: Доступ запрещён (недостаточно прав)
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            success: false
            message: Insufficient permissions
            code: FORBIDDEN
    
    NotFound:
      description: Ресурс не найден
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            success: false
            message: Resource not found
            code: NOT_FOUND

